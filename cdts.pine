//@version=6
strategy("CDTS Institutional System", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=5)

input_group_core = "Core Market Analysis"
fast_ema = input.int(7, title="Fast EMA", minval=1, group=input_group_core)
slow_ema = input.int(21, title="Slow EMA", minval=1, group=input_group_core)
trend_ema = input.int(50, title="Trend EMA", minval=1, group=input_group_core)

input_group_bb = "Dynamic Bollinger Bands"
bb_period = input.int(20, title="BB Period", minval=1, group=input_group_bb)
bb_upper_mult = input.float(2.2, title="Upper Multiplier", minval=0.5, group=input_group_bb)
bb_lower_mult = input.float(2.0, title="Lower Multiplier", minval=0.5, group=input_group_bb)

input_group_rsi = "RSI Divergence Detection"
rsi_period = input.int(14, title="RSI Period", minval=1, group=input_group_rsi)
rsi_bullish_threshold = input.int(30, title="Bullish Divergence Level", minval=1, maxval=50, group=input_group_rsi)
rsi_bearish_threshold = input.int(70, title="Bearish Divergence Level", minval=50, maxval=99, group=input_group_rsi)

input_group_macd = "MACD Confluence"
macd_fast = input.int(12, title="MACD Fast", minval=1, group=input_group_macd)
macd_slow = input.int(26, title="MACD Slow", minval=1, group=input_group_macd)
macd_signal = input.int(9, title="MACD Signal", minval=1, group=input_group_macd)

input_group_stoch = "Stochastic Oscillator"
stoch_k = input.int(14, title="Stoch K Period", minval=1, group=input_group_stoch)
stoch_d = input.int(3, title="Stoch D Period", minval=1, group=input_group_stoch)
stoch_smooth = input.int(3, title="Stoch Smoothing", minval=1, group=input_group_stoch)

input_group_atr = "Volatility & Risk"
atr_period = input.int(14, title="ATR Period", minval=1, group=input_group_atr)
atr_sl_mult = input.float(1.8, title="ATR SL Multiplier", minval=0.5, group=input_group_atr)
atr_tp_mult = input.float(3.2, title="ATR TP Multiplier", minval=1.0, group=input_group_atr)

input_group_vol = "Volume & Strength"
volume_lookback = input.int(20, title="Volume Lookback", minval=5, group=input_group_vol)
volume_multiplier = input.float(1.4, title="Volume Spike Multiplier", minval=1.0, group=input_group_vol)

input_group_regime = "Market Regime Detection"
volatility_period = input.int(30, title="Volatility Period", minval=10, group=input_group_regime)
trend_strength_period = input.int(10, title="Trend Strength Period", minval=5, group=input_group_regime)

input_group_pos = "Position Management"
max_consecutive_loss = input.int(3, title="Max Consecutive Losses", minval=1, group=input_group_pos)
max_bars_hold = input.int(120, title="Max Bars Hold", minval=10, group=input_group_pos)
trailing_stop_pct = input.float(1.5, title="Trailing Stop %", minval=0.1, group=input_group_pos)

fast_line = ta.ema(close, fast_ema)
slow_line = ta.ema(close, slow_ema)
trend_line = ta.ema(close, trend_ema)

bb_mid = ta.sma(close, bb_period)
bb_dev = ta.stdev(close, bb_period)
bb_upper = bb_mid + (bb_dev * bb_upper_mult)
bb_lower = bb_mid - (bb_dev * bb_lower_mult)
bb_width = bb_upper - bb_lower
bb_width_pct = (bb_width / bb_mid) * 100

rsi_value = ta.rsi(close, rsi_period)

macd_line = ta.ema(close, macd_fast) - ta.ema(close, macd_slow)
macd_signal_line = ta.ema(macd_line, macd_signal)
macd_histogram = macd_line - macd_signal_line

lowest = ta.lowest(low, stoch_k)
highest = ta.highest(high, stoch_k)
stoch_raw = 100 * (close - lowest) / (highest - lowest + 0.0001)
stoch_k_line = ta.sma(stoch_raw, stoch_smooth)
stoch_d_line = ta.sma(stoch_k_line, stoch_d)

atr_value = ta.atr(atr_period)
avg_volume = ta.sma(volume, volume_lookback)
volume_ratio = volume / (avg_volume + 0.0001)

trend_direction = fast_line > slow_line
trend_strength = math.abs(fast_line - slow_line) / close * 100

volatility_current = ta.stdev(close, volatility_period)
volatility_avg = ta.sma(volatility_current, volatility_period)
volatility_regime = volatility_current > volatility_avg

rsi_div_bullish = (low < low[1] and rsi_value > rsi_value[1]) and rsi_value < rsi_bullish_threshold
rsi_div_bearish = (high > high[1] and rsi_value < rsi_value[1]) and rsi_value > rsi_bearish_threshold

macd_bullish_cross = ta.crossover(macd_line, macd_signal_line)
macd_bearish_cross = ta.crossunder(macd_line, macd_signal_line)

stoch_bullish_cross = ta.crossover(stoch_k_line, stoch_d_line) and stoch_k_line < 30
stoch_bearish_cross = ta.crossunder(stoch_k_line, stoch_d_line) and stoch_k_line > 70

bb_bounce_up = (close > bb_lower) and (close[1] <= bb_lower) and volume_ratio > 1.2
bb_bounce_down = (close < bb_upper) and (close[1] >= bb_upper) and volume_ratio > 1.2

bb_squeeze = bb_width_pct < 12
bb_expand = bb_width_pct > 35

volume_surge = volume_ratio > volume_multiplier
volume_decline = volume_ratio < 0.7

candle_bullish = (close > open) and ((close - open) / (high - low + 0.0001)) > 0.6
candle_bearish = (close < open) and ((open - close) / (high - low + 0.0001)) > 0.6

trend_confirmation_buy = (close > bb_mid) and trend_direction and (trend_strength > 0.5)
trend_confirmation_sell = (close < bb_mid) and not trend_direction and (trend_strength > 0.5)

buy_signal_stage1 = (rsi_div_bullish or (macd_bullish_cross and macd_line > 0)) and volume_surge
buy_signal_stage2 = buy_signal_stage1 and trend_confirmation_buy and (close > trend_line or volatility_regime)
buy_signal_stage3 = (bb_bounce_up or stoch_bullish_cross) and trend_direction and volume_surge

sell_signal_stage1 = (rsi_div_bearish or (macd_bearish_cross and macd_line < 0)) and volume_surge
sell_signal_stage2 = sell_signal_stage1 and trend_confirmation_sell and (close < trend_line or volatility_regime)
sell_signal_stage3 = (bb_bounce_down or stoch_bearish_cross) and not trend_direction and volume_surge

buy_final = buy_signal_stage2 or buy_signal_stage3
sell_final = sell_signal_stage2 or sell_signal_stage3

var float entry_price = na
var int bars_in_trade = 0
var float stop_loss_price = na
var float take_profit_price = na
var float trailing_stop = na
var int consecutive_losses = 0
var float max_profit = 0.0
var int last_trade_profit = 0

if buy_final and strategy.position_size == 0
    entry_price := close
    stop_loss_price := entry_price - (atr_value * atr_sl_mult)
    take_profit_price := entry_price + (atr_value * atr_tp_mult)
    trailing_stop := entry_price
    bars_in_trade := 0
    max_profit := 0
    strategy.entry("BUY", strategy.long)
    last_trade_profit := 1

if sell_final and strategy.position_size == 0
    entry_price := close
    stop_loss_price := entry_price + (atr_value * atr_sl_mult)
    take_profit_price := entry_price - (atr_value * atr_tp_mult)
    trailing_stop := entry_price
    bars_in_trade := 0
    max_profit := 0
    strategy.entry("SELL", strategy.short)
    last_trade_profit := 0

if strategy.position_size > 0
    bars_in_trade += 1
    current_profit = (close - entry_price) / entry_price * 100
    if current_profit > max_profit
        max_profit := current_profit
        trailing_stop := close - (atr_value * trailing_stop_pct / 100 * close)
    if bars_in_trade > max_bars_hold
        strategy.close("BUY")
    else
        strategy.exit("BUY_EXIT", "BUY", stop=math.max(stop_loss_price, trailing_stop), limit=take_profit_price)

if strategy.position_size < 0
    bars_in_trade += 1
    current_profit = (entry_price - close) / entry_price * 100
    if current_profit > max_profit
        max_profit := current_profit
        trailing_stop := close + (atr_value * trailing_stop_pct / 100 * close)
    if bars_in_trade > max_bars_hold
        strategy.close("SELL")
    else
        strategy.exit("SELL_EXIT", "SELL", stop=math.min(stop_loss_price, trailing_stop), limit=take_profit_price)

plot(fast_line, color=color.new(color.blue, 0), linewidth=2, title="Fast EMA")
plot(slow_line, color=color.new(color.orange, 0), linewidth=2, title="Slow EMA")
plot(trend_line, color=color.new(color.red, 0), linewidth=1, title="Trend EMA")

plot(bb_upper, color=color.new(color.gray, 60), linewidth=1, title="BB Upper")
plot(bb_mid, color=color.new(color.gray, 40), linewidth=1, title="BB Mid")
plot(bb_lower, color=color.new(color.gray, 60), linewidth=1, title="BB Lower")

fill(plot(bb_upper, color=na, title=na), plot(bb_lower, color=na, title=na), color=bb_squeeze ? color.new(color.yellow, 80) : color.new(color.gray, 95))

plotshape(buy_final, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.small)
plotshape(sell_final, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.small)

plot(stoch_k_line, color=color.new(color.purple, 0), linewidth=1, title="Stoch K", display=display.none)
plot(stoch_d_line, color=color.new(color.teal, 0), linewidth=1, title="Stoch D", display=display.none)
