//@version=6
strategy("CDTS Zero-Lag Adaptive", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=5)

input_group_1 = "Zero-Lag EMA Settings"
fast_len = input.int(9, title="Fast ZLEMA", minval=1, group=input_group_1)
slow_len = input.int(21, title="Slow ZLEMA", minval=1, group=input_group_1)

input_group_2 = "Momentum Settings"
mom_period = input.int(5, title="Real-Time Momentum Period", minval=1, group=input_group_2)
v_threshold = input.float(0.5, title="Volatility Threshold", minval=0.1, group=input_group_2)

input_group_3 = "Adaptive Risk"
atr_len = input.int(14, title="ATR Period", minval=1, group=input_group_3)
sl_mult = input.float(1.5, title="SL Multiplier", minval=0.5, group=input_group_3)
tp_mult = input.float(2.5, title="TP Multiplier", minval=1.0, group=input_group_3)
max_bars = input.int(80, title="Max Hold Bars", minval=10, group=input_group_3)

zlema(src, length) =>
    ema1 = ta.ema(src, length)
    ema2 = ta.ema(ema1, length)
    ema1 * 2 - ema2

zlema_fast = zlema(close, fast_len)
zlema_slow = zlema(close, slow_len)

body_size = math.abs(close - open)
wicks_sum = (high - math.max(close, open)) + (math.min(close, open) - low)
total_range = high - low

body_ratio = body_size / (total_range + 0.0001)
wick_ratio = wicks_sum / (total_range + 0.0001)

momentum_raw = (close - close[1]) * body_ratio
volatility_raw = ta.atr(atr_len) / close * 100
volatility_adaptive = ta.ema(volatility_raw, 5)

momentum_instant = momentum_raw * (1 + volatility_adaptive / 100)

price_momentum_score = 0.0
for i = 0 to math.min(mom_period - 1, 4)
    if i < mom_period
        price_momentum_score += (close[i] > open[i] ? 1 : -1) * body_ratio[i]

price_momentum_score := price_momentum_score / mom_period

high_low_diff = high - low
high_low_avg = ta.sma(high_low_diff, 20)
volatility_expansion = high_low_diff > (high_low_avg * 1.5)

div_bullish = low < low[1] and momentum_instant > momentum_instant[1] and momentum_instant > 0
div_bearish = high > high[1] and momentum_instant < momentum_instant[1] and momentum_instant < 0

trend_up = zlema_fast > zlema_slow
trend_down = zlema_fast < zlema_slow

volume_strength = volume > ta.sma(volume, 20) * 1.2

candle_bullish = close > open and body_ratio > 0.6 and wicks_sum < body_size
candle_bearish = close < open and body_ratio > 0.6 and wicks_sum < body_size

acceleration_up = momentum_instant > momentum_instant[1] and momentum_instant > 0
acceleration_down = momentum_instant < momentum_instant[1] and momentum_instant < 0

buy_trigger1 = trend_up and acceleration_up and volume_strength
buy_trigger2 = div_bullish and trend_up and candle_bullish
buy_trigger3 = (zlema_fast > zlema_slow and zlema_fast[1] <= zlema_slow[1]) and volume_strength

buy_signal = buy_trigger1 or buy_trigger2 or buy_trigger3

sell_trigger1 = trend_down and acceleration_down and volume_strength
sell_trigger2 = div_bearish and trend_down and candle_bearish
sell_trigger3 = (zlema_fast < zlema_slow and zlema_fast[1] >= zlema_slow[1]) and volume_strength

sell_signal = sell_trigger1 or sell_trigger2 or sell_trigger3

var float entry_price = na
var int bars_in_trade = 0
var float stop_loss = na
var float take_profit = na
var float current_atr = na

if buy_signal and strategy.position_size == 0
    entry_price := close
    current_atr := ta.atr(atr_len)
    stop_loss := entry_price - (current_atr * sl_mult)
    take_profit := entry_price + (current_atr * tp_mult)
    bars_in_trade := 0
    strategy.entry("LONG", strategy.long)

if sell_signal and strategy.position_size == 0
    entry_price := close
    current_atr := ta.atr(atr_len)
    stop_loss := entry_price + (current_atr * sl_mult)
    take_profit := entry_price - (current_atr * tp_mult)
    bars_in_trade := 0
    strategy.entry("SHORT", strategy.short)

if strategy.position_size > 0
    bars_in_trade += 1
    strategy.exit("LONG_EXIT", "LONG", stop=stop_loss, limit=take_profit)
    if bars_in_trade > max_bars
        strategy.close("LONG")

if strategy.position_size < 0
    bars_in_trade += 1
    strategy.exit("SHORT_EXIT", "SHORT", stop=stop_loss, limit=take_profit)
    if bars_in_trade > max_bars
        strategy.close("SHORT")

plot(zlema_fast, color=color.new(color.blue, 0), linewidth=2, title="ZLEMA Fast")
plot(zlema_slow, color=color.new(color.orange, 0), linewidth=2, title="ZLEMA Slow")

plot(momentum_instant * 100, color=color.new(color.purple, 0), linewidth=1, title="Instant Momentum")
hline(0, color=color.new(color.black, 50), linestyle=hline.style_dashed, title="Zero Line")

plotshape(buy_signal, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.small)
plotshape(sell_signal, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.small)
