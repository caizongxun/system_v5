//@version=6
strategy("CDTS Multi-TF Confluence", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=5)

input_group_1 = "Multi-Timeframe Configuration"
higher_tf = input.timeframe("240", title="Higher TF (Bias)", group=input_group_1)
mid_tf = input.timeframe("60", title="Middle TF (Setup)", group=input_group_1)

input_group_2 = "Mean Reversion Settings"
basis_len = input.int(20, title="Basis Period (EMA)", minval=1, group=input_group_2)
dev_mult = input.float(1.8, title="Deviation Multiplier", minval=0.5, group=input_group_2)

input_group_3 = "Volume Profile Settings"
vol_lookback = input.int(50, title="Volume Lookback", minval=10, group=input_group_3)
node_threshold = input.float(1.5, title="Volume Node Multiplier", minval=1.0, group=input_group_3)

input_group_4 = "Confluence Filter"
rsi_len = input.int(14, title="RSI Period", minval=1, group=input_group_4)
rsi_oversold = input.int(35, title="RSI Oversold", minval=1, maxval=50, group=input_group_4)
rsi_overbought = input.int(65, title="RSI Overbought", minval=50, maxval=99, group=input_group_4)

input_group_5 = "Risk Management"
atr_len = input.int(14, title="ATR Period", minval=1, group=input_group_5)
risk_reward = input.float(3.0, title="Risk-Reward Ratio", minval=1.0, group=input_group_5)
max_bars = input.int(100, title="Max Hold Bars", minval=10, group=input_group_5)

basis_ema = ta.ema(close, basis_len)
basis_dev = ta.stdev(close, basis_len) * dev_mult
upper_band = basis_ema + basis_dev
lower_band = basis_ema - basis_dev

high_basis_ema = request.security(syminfo.tickerid, higher_tf, ta.ema(close, basis_len))
high_basis_dev = request.security(syminfo.tickerid, higher_tf, ta.stdev(close, basis_len) * dev_mult)
high_upper_band = high_basis_ema + high_basis_dev
high_lower_band = high_basis_ema - high_basis_dev

mid_basis_ema = request.security(syminfo.tickerid, mid_tf, ta.ema(close, basis_len))
mid_upper_band = request.security(syminfo.tickerid, mid_tf, ta.ema(close, basis_len) + ta.stdev(close, basis_len) * dev_mult)
mid_lower_band = request.security(syminfo.tickerid, mid_tf, ta.ema(close, basis_len) - ta.stdev(close, basis_len) * dev_mult)

rsi_val = ta.rsi(close, rsi_len)
atr_val = ta.atr(atr_len)

avg_vol = ta.sma(volume, 20)
volume_strength = volume > (avg_vol * 1.3)

high_vol_nodes = 0.0
for i = 1 to vol_lookback
    if high[i] < high and low[i] > low
        if volume[i] > ta.sma(volume, 20) * node_threshold
            high_vol_nodes += 1

high_trend = high_basis_ema > high_basis_ema[1]
low_trend = high_basis_ema < high_basis_ema[1]

trend_agreement_mid = mid_basis_ema > mid_basis_ema[1]

close_to_basis = math.abs(close - basis_ema) < basis_dev * 0.5
close_to_lower = close > lower_band and close < (lower_band + basis_dev * 0.3)
close_to_upper = close < upper_band and close > (upper_band - basis_dev * 0.3)

mean_revert_up = close_to_lower and rsi_val < rsi_oversold
mean_revert_down = close_to_upper and rsi_val > rsi_overbought

bounce_up = (close > lower_band) and (close[1] <= lower_band) and volume_strength
bounce_down = (close < upper_band) and (close[1] >= upper_band) and volume_strength

buy_signal = (mean_revert_up or bounce_up) and high_trend and trend_agreement_mid and volume_strength
sell_signal = (mean_revert_down or bounce_down) and low_trend and not trend_agreement_mid and volume_strength

var float entry_price = na
var int bars_in_trade = 0
var float stop_loss = na
var float take_profit = na
var float current_atr = na

if buy_signal and strategy.position_size == 0
    entry_price := close
    current_atr := atr_val
    stop_loss := entry_price - current_atr
    take_profit := entry_price + (current_atr * risk_reward)
    bars_in_trade := 0
    strategy.entry("LONG", strategy.long)

if sell_signal and strategy.position_size == 0
    entry_price := close
    current_atr := atr_val
    stop_loss := entry_price + current_atr
    take_profit := entry_price - (current_atr * risk_reward)
    bars_in_trade := 0
    strategy.entry("SHORT", strategy.short)

if strategy.position_size > 0
    bars_in_trade += 1
    strategy.exit("LONG_EXIT", "LONG", stop=stop_loss, limit=take_profit)
    if bars_in_trade > max_bars
        strategy.close("LONG")

if strategy.position_size < 0
    bars_in_trade += 1
    strategy.exit("SHORT_EXIT", "SHORT", stop=stop_loss, limit=take_profit)
    if bars_in_trade > max_bars
        strategy.close("SHORT")

plot(upper_band, color=color.new(color.blue, 60), linewidth=1, title="Upper Band")
plot(basis_ema, color=color.new(color.gray, 60), linewidth=1, title="Basis EMA")
plot(lower_band, color=color.new(color.blue, 60), linewidth=1, title="Lower Band")

plot(high_upper_band, color=color.new(color.red, 80), linewidth=1, title="Higher TF Upper", display=display.none)
plot(high_basis_ema, color=color.new(color.orange, 80), linewidth=1, title="Higher TF Basis", display=display.none)
plot(high_lower_band, color=color.new(color.red, 80), linewidth=1, title="Higher TF Lower", display=display.none)

plotshape(buy_signal, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.small)
plotshape(sell_signal, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.small)

plot(rsi_val, color=color.new(color.purple, 0), linewidth=1, title="RSI", display=display.none)
