//@version=6
strategy("CDTS - Crypto Day Trading System", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

input_group_1 = "Timeframe Configuration"
tf_4h = input.timeframe("240", title="4H Timeframe", group=input_group_1)
tf_1h = input.timeframe("60", title="1H Timeframe", group=input_group_1)
tf_15m = input.timeframe("15", title="15M Timeframe", group=input_group_1)

input_group_2 = "EMA Parameters"
ema_5_len = input.int(5, title="EMA5 Length", minval=1, group=input_group_2)
ema_12_len = input.int(12, title="EMA12 Length", minval=1, group=input_group_2)
ema_20_len = input.int(20, title="EMA20 Length", minval=1, group=input_group_2)
ema_50_len = input.int(50, title="EMA50 Length", minval=1, group=input_group_2)
ema_200_len = input.int(200, title="EMA200 Length", minval=1, group=input_group_2)

input_group_3 = "Bollinger Bands Parameters"
bb_len = input.int(20, title="BB Length", minval=1, group=input_group_3)
bb_std = input.float(2.0, title="BB Standard Deviation", minval=0.1, group=input_group_3)

input_group_4 = "RSI Parameters"
rsi_len = input.int(14, title="RSI Length", minval=1, group=input_group_4)
rsi_oversold = input.int(30, title="RSI Oversold Level", minval=1, maxval=50, group=input_group_4)
rsi_overbought = input.int(70, title="RSI Overbought Level", minval=50, maxval=99, group=input_group_4)

input_group_5 = "Stochastic Parameters"
stoch_k = input.int(14, title="Stochastic K Period", minval=1, group=input_group_5)
stoch_d = input.int(3, title="Stochastic D Period", minval=1, group=input_group_5)
stoch_smooth = input.int(3, title="Stochastic Smoothing", minval=1, group=input_group_5)
stoch_oversold = input.int(20, title="Stochastic Oversold Level", minval=1, maxval=50, group=input_group_5)
stoch_overbought = input.int(80, title="Stochastic Overbought Level", minval=50, maxval=99, group=input_group_5)

input_group_6 = "MACD Parameters"
macd_fast = input.int(12, title="MACD Fast Length", minval=1, group=input_group_6)
macd_slow = input.int(26, title="MACD Slow Length", minval=1, group=input_group_6)
macd_signal = input.int(9, title="MACD Signal Length", minval=1, group=input_group_6)

input_group_7 = "ATR Parameters"
atr_len = input.int(14, title="ATR Length", minval=1, group=input_group_7)
atr_mult_sl = input.float(1.5, title="ATR Multiplier for SL", minval=0.1, group=input_group_7)
atr_mult_tp = input.float(2.25, title="ATR Multiplier for TP", minval=0.1, group=input_group_7)

input_group_8 = "OBV Parameters"
obv_len = input.int(20, title="OBV EMA Length", minval=1, group=input_group_8)
volume_threshold = input.float(1.4, title="Volume Confirmation Multiplier", minval=1.0, group=input_group_8)

input_group_9 = "Signal Filtering Sensitivity"
filter_sensitivity = input.string("BALANCED", title="Filter Sensitivity", options=["AGGRESSIVE", "BALANCED", "CONSERVATIVE"], group=input_group_9)
adr_threshold = input.float(25.0, title="ADX Threshold", minval=10, group=input_group_9)
bb_width_threshold = input.float(0.015, title="BB Width Min Threshold", minval=0.001, group=input_group_9)

input_group_10 = "Risk Management"
risk_percent = input.float(0.5, title="Risk Per Trade", minval=0.1, maxval=2.0, group=input_group_10)

calc_ema(length, source) => ta.ema(source, length)

ema_5_15m = calc_ema(ema_5_len, close)
ema_12_15m = calc_ema(ema_12_len, close)
ema_20_15m = calc_ema(ema_20_len, close)
ema_50_15m = calc_ema(ema_50_len, close)
ema_200_15m = calc_ema(ema_200_len, close)

ema_50_4h = request.security(syminfo.tickerid, tf_4h, calc_ema(ema_50_len, close))
ema_200_4h = request.security(syminfo.tickerid, tf_4h, calc_ema(ema_200_len, close))
ema_12_1h = request.security(syminfo.tickerid, tf_1h, calc_ema(ema_12_len, close))
ema_50_1h = request.security(syminfo.tickerid, tf_1h, calc_ema(ema_50_len, close))

bb_mid = ta.sma(close, bb_len)
bb_std_dev = ta.stdev(close, bb_len) * bb_std
bb_upper = bb_mid + bb_std_dev
bb_lower = bb_mid - bb_std_dev

rsi_val = ta.rsi(close, rsi_len)

stoch_high = ta.highest(high, stoch_k)
stoch_low = ta.lowest(low, stoch_k)
stoch_k_val = 100 * (close - stoch_low) / (stoch_high - stoch_low)
stoch_d_val = ta.sma(stoch_k_val, stoch_d)

macd_line = ta.ema(close, macd_fast) - ta.ema(close, macd_slow)
macd_signal_line = ta.sma(macd_line, macd_signal)
macd_hist = macd_line - macd_signal_line

atr_val = ta.atr(atr_len)
obv_val = ta.obv(close, volume)
obv_ema = ta.ema(obv_val, obv_len)

adx_plus = ta.ema(ta.change(high) > 0 ? ta.change(high) : 0, 14)
adx_minus = ta.ema(ta.change(low) < 0 ? -ta.change(low) : 0, 14)
adx_val = 100 * ta.sma(math.abs(adx_plus - adx_minus) / (adx_plus + adx_minus), 14)

avg_volume = ta.sma(volume, 5)

bb_width = bb_upper - bb_lower
bb_width_percent = (bb_width / close) * 100

trend_4h_bullish = ema_50_4h > ema_200_4h
trend_4h_bearish = ema_50_4h < ema_200_4h
trend_1h_bullish = ema_12_1h > ema_50_1h
trend_1h_bearish = ema_12_1h < ema_50_1h

price_near_bb_lower = close < bb_mid and close > bb_lower
price_near_bb_upper = close > bb_mid and close < bb_upper

rsi_oversold_cond = rsi_val < rsi_oversold
rsi_overbought_cond = rsi_val > rsi_overbought

stoch_oversold_cond = stoch_k_val < stoch_oversold
stoch_overbought_cond = stoch_k_val > stoch_overbought

macd_bullish = macd_line > macd_signal_line
macd_bearish = macd_line < macd_signal_line
macd_bullish_cross = ta.crossover(macd_line, macd_signal_line)
macd_bearish_cross = ta.crossunder(macd_line, macd_signal_line)

ema_5_above_20 = ema_5_15m > ema_20_15m
ema_5_below_20 = ema_5_15m < ema_20_15m
ema_5_cross_20_up = ta.crossover(ema_5_15m, ema_20_15m)
ema_5_cross_20_down = ta.crossunder(ema_5_15m, ema_20_15m)

volume_confirmed = volume > (avg_volume * volume_threshold)
obv_trending_up = obv_val > obv_ema
obv_trending_down = obv_val < obv_ema

bb_width_valid = bb_width_percent > bb_width_threshold
adx_valid = adx_val > adr_threshold

price_cross_bb_mid_up = ta.crossover(close, bb_mid)
price_cross_bb_mid_down = ta.crossunder(close, bb_mid)

get_filter_threshold() => filter_sensitivity == "AGGRESSIVE" ? 2 : filter_sensitivity == "CONSERVATIVE" ? 5 : 3

buy_base_score = 0.0
buy_base_score += trend_4h_bullish ? 1 : 0
buy_base_score += trend_1h_bullish ? 1 : 0
buy_base_score += price_near_bb_lower ? 1 : 0
buy_base_score += (rsi_oversold_cond or stoch_oversold_cond) ? 1 : 0
buy_base_score += (macd_bullish or macd_bullish_cross) ? 1 : 0
buy_base_score += (ema_5_above_20 or ema_5_cross_20_up) ? 1 : 0
buy_base_score += obv_trending_up ? 1 : 0

buy_volume_score = volume_confirmed ? 2 : 0
buy_pattern_score = price_cross_bb_mid_up ? 2 : 0
buy_confluence_score = adx_valid ? 1 : 0

buy_total_score = buy_base_score + buy_volume_score + buy_pattern_score + buy_confluence_score

sell_base_score = 0.0
sell_base_score += trend_4h_bearish ? 1 : 0
sell_base_score += trend_1h_bearish ? 1 : 0
sell_base_score += price_near_bb_upper ? 1 : 0
sell_base_score += (rsi_overbought_cond or stoch_overbought_cond) ? 1 : 0
sell_base_score += (macd_bearish or macd_bearish_cross) ? 1 : 0
sell_base_score += (ema_5_below_20 or ema_5_cross_20_down) ? 1 : 0
sell_base_score += obv_trending_down ? 1 : 0

sell_volume_score = volume_confirmed ? 2 : 0
sell_pattern_score = price_cross_bb_mid_down ? 2 : 0
sell_confluence_score = adx_valid ? 1 : 0

sell_total_score = sell_base_score + sell_volume_score + sell_pattern_score + sell_confluence_score

filter_threshold = get_filter_threshold()

buy_signal_qualified = buy_total_score >= filter_threshold and bb_width_valid and volume_confirmed
sell_signal_qualified = sell_total_score >= filter_threshold and bb_width_valid and volume_confirmed

buy_entry_confirmed = buy_signal_qualified and price_cross_bb_mid_up
sell_entry_confirmed = sell_signal_qualified and price_cross_bb_mid_down

atr_stop_loss_buy = atr_val * atr_mult_sl
atr_take_profit_buy = atr_val * atr_mult_tp
atr_stop_loss_sell = atr_val * atr_mult_sl
atr_take_profit_sell = atr_val * atr_mult_tp

entry_buy_price = close
entry_sell_price = close

stop_loss_buy = entry_buy_price - atr_stop_loss_buy
take_profit_buy = entry_buy_price + atr_take_profit_buy
stop_loss_sell = entry_sell_price + atr_stop_loss_sell
take_profit_sell = entry_sell_price - atr_take_profit_sell

if buy_entry_confirmed and strategy.position_size == 0
    strategy.entry("Buy", strategy.long)

if sell_entry_confirmed and strategy.position_size == 0
    strategy.entry("Sell", strategy.short)

if strategy.position_size > 0
    strategy.exit("CloseBuy", "Buy", stop=stop_loss_buy, limit=take_profit_buy)

if strategy.position_size < 0
    strategy.exit("CloseSell", "Sell", stop=stop_loss_sell, limit=take_profit_sell)

plotshape(buy_entry_confirmed, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.small)
plotshape(sell_entry_confirmed, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.small)

plot(ema_5_15m, color=color.new(color.blue, 0), linewidth=1, title="EMA5")
plot(ema_20_15m, color=color.new(color.orange, 0), linewidth=1, title="EMA20")
plot(bb_upper, color=color.new(color.gray, 50), linewidth=1, title="BB Upper")
plot(bb_mid, color=color.new(color.gray, 50), linewidth=1, title="BB Middle")
plot(bb_lower, color=color.new(color.gray, 50), linewidth=1, title="BB Lower")
