//@version=6
strategy("CDTS - Crypto Day Trading System", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=10)

input_group_1 = "Timeframe Configuration"
tf_4h = input.timeframe("240", title="4H Timeframe", group=input_group_1)
tf_1h = input.timeframe("60", title="1H Timeframe", group=input_group_1)

input_group_2 = "EMA Parameters"
ema_8_len = input.int(8, title="EMA8 Length", minval=1, group=input_group_2)
ema_21_len = input.int(21, title="EMA21 Length", minval=1, group=input_group_2)
ema_50_len = input.int(50, title="EMA50 Length", minval=1, group=input_group_2)
ema_200_len = input.int(200, title="EMA200 Length", minval=1, group=input_group_2)

input_group_3 = "RSI Parameters"
rsi_len = input.int(14, title="RSI Length", minval=1, group=input_group_3)
rsi_oversold = input.int(35, title="RSI Oversold", minval=1, maxval=50, group=input_group_3)
rsi_overbought = input.int(65, title="RSI Overbought", minval=50, maxval=99, group=input_group_3)

input_group_4 = "Bollinger Bands Parameters"
bb_len = input.int(20, title="BB Length", minval=1, group=input_group_4)
bb_std = input.float(2.0, title="BB Std Dev", minval=0.1, group=input_group_4)

input_group_5 = "Signal Filter"
volume_min_ratio = input.float(1.5, title="Min Volume Ratio", minval=1.0, group=input_group_5)
trend_strength = input.int(5, title="Trend Strength Bars", minval=1, group=input_group_5)
confirm_bars = input.int(2, title="Confirmation Bars", minval=1, group=input_group_5)

input_group_6 = "Risk Management"
atr_len = input.int(14, title="ATR Length", minval=1, group=input_group_6)
sl_mult = input.float(1.2, title="SL Multiplier", minval=0.5, group=input_group_6)
tp_mult = input.float(2.5, title="TP Multiplier", minval=1.0, group=input_group_6)
max_bars_hold = input.int(100, title="Max Bars Hold", minval=10, group=input_group_6)

calc_ema(length, source) => ta.ema(source, length)

ema_8 = calc_ema(ema_8_len, close)
ema_21 = calc_ema(ema_21_len, close)
ema_50 = calc_ema(ema_50_len, close)
ema_200 = calc_ema(ema_200_len, close)

ema_50_4h = request.security(syminfo.tickerid, tf_4h, calc_ema(ema_50_len, close))
ema_200_4h = request.security(syminfo.tickerid, tf_4h, calc_ema(ema_200_len, close))

bb_mid = ta.sma(close, bb_len)
bb_std_dev = ta.stdev(close, bb_len) * bb_std
bb_upper = bb_mid + bb_std_dev
bb_lower = bb_mid - bb_std_dev

rsi_val = ta.rsi(close, rsi_len)
atr_val = ta.atr(atr_len)
avg_vol = ta.sma(volume, 20)

trend_4h_bullish = ema_50_4h > ema_200_4h
trend_4h_bearish = ema_50_4h < ema_200_4h

trend_1h_bullish = ema_50 > ema_200
trend_1h_bearish = ema_50 < ema_200

trend_strength_up = ema_8 > ema_21 and ema_21 > ema_50
trend_strength_down = ema_8 < ema_21 and ema_21 < ema_50

bb_squeeze = bb_std_dev < (bb_mid * 0.02)
bb_lower_touch = close <= bb_lower
bb_upper_touch = close >= bb_upper

rsi_extreme_low = rsi_val < rsi_oversold
rsi_extreme_high = rsi_val > rsi_overbought

volume_surge = volume > (avg_vol * volume_min_ratio)

price_above_ema21 = close > ema_21
price_below_ema21 = close < ema_21

price_above_ema8 = close > ema_8
price_below_ema8 = close < ema_8

rsi_cross_up = ta.crossover(rsi_val, rsi_oversold)
rsi_cross_down = ta.crossunder(rsi_val, rsi_overbought)

close_higher_than_open = close > open
close_lower_than_open = close < open

bars_since_trend_start = 0.0
bars_since_trend_start := trend_strength_up ? nz(bars_since_trend_start) + 1 : 0

bars_since_reversal = 0.0
bars_since_reversal := trend_strength_down ? nz(bars_since_reversal) + 1 : 0

buy_score = 0.0
buy_score := 0
buy_score += trend_4h_bullish ? 2 : 0
buy_score += trend_1h_bullish ? 2 : 0
buy_score += trend_strength_up ? 2 : 0
buy_score += price_above_ema21 ? 1 : 0
buy_score += price_above_ema8 ? 1 : 0
buy_score += bb_lower_touch ? 2 : 0
buy_score += rsi_extreme_low ? 2 : 0
buy_score += rsi_cross_up ? 2 : 0
buy_score += volume_surge ? 1 : 0
buy_score += close_higher_than_open ? 1 : 0
buy_score += not bb_squeeze ? 1 : 0

sell_score = 0.0
sell_score := 0
sell_score += trend_4h_bearish ? 2 : 0
sell_score += trend_1h_bearish ? 2 : 0
sell_score += trend_strength_down ? 2 : 0
sell_score += price_below_ema21 ? 1 : 0
sell_score += price_below_ema8 ? 1 : 0
sell_score += bb_upper_touch ? 2 : 0
sell_score += rsi_extreme_high ? 2 : 0
sell_score += rsi_cross_down ? 2 : 0
sell_score += volume_surge ? 1 : 0
sell_score += close_lower_than_open ? 1 : 0
sell_score += not bb_squeeze ? 1 : 0

buy_qualified = buy_score >= 12 and volume_surge and not bb_squeeze
sell_qualified = sell_score >= 12 and volume_surge and not bb_squeeze

buy_confirmed = buy_qualified and price_above_ema21 and bb_lower_touch
sell_confirmed = sell_qualified and price_below_ema21 and bb_upper_touch

atr_stop = atr_val * sl_mult
atr_profit = atr_val * tp_mult

var float entry_price = na
var int bars_in_trade = 0

if buy_confirmed and strategy.position_size == 0
    entry_price := close
    bars_in_trade := 0
    strategy.entry("Buy", strategy.long)

if sell_confirmed and strategy.position_size == 0
    entry_price := close
    bars_in_trade := 0
    strategy.entry("Sell", strategy.short)

if strategy.position_size != 0
    bars_in_trade += 1

if strategy.position_size > 0
    strategy.exit("CloseBuy", "Buy", stop=entry_price - atr_stop, limit=entry_price + atr_profit)
    if bars_in_trade > max_bars_hold
        strategy.close("Buy")

if strategy.position_size < 0
    strategy.exit("CloseSell", "Sell", stop=entry_price + atr_stop, limit=entry_price - atr_profit)
    if bars_in_trade > max_bars_hold
        strategy.close("Sell")

plotshape(buy_confirmed, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.small)
plotshape(sell_confirmed, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.small)

plot(ema_8, color=color.new(color.blue, 0), linewidth=1, title="EMA8")
plot(ema_21, color=color.new(color.yellow, 0), linewidth=1, title="EMA21")
plot(ema_50, color=color.new(color.orange, 0), linewidth=1, title="EMA50")
plot(ema_200, color=color.new(color.red, 0), linewidth=2, title="EMA200")
plot(bb_upper, color=color.new(color.gray, 60), linewidth=1, title="BB Upper")
plot(bb_mid, color=color.new(color.gray, 60), linewidth=1, title="BB Mid")
plot(bb_lower, color=color.new(color.gray, 60), linewidth=1, title="BB Lower")
