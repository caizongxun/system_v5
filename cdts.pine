//@version=6
strategy("CDTS 15M Scalping System", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=5)

input_group_1 = "MA Settings"
ema_fast_len = input.int(5, title="Fast EMA", minval=1, group=input_group_1)
ema_slow_len = input.int(20, title="Slow EMA", minval=1, group=input_group_1)

input_group_2 = "RSI Settings"
rsi_len = input.int(14, title="RSI Period", minval=1, group=input_group_2)
rsi_oversold = input.int(40, title="RSI Oversold", minval=1, maxval=50, group=input_group_2)
rsi_overbought = input.int(60, title="RSI Overbought", minval=50, maxval=99, group=input_group_2)

input_group_3 = "MACD Settings"
macd_fast = input.int(12, title="MACD Fast", minval=1, group=input_group_3)
macd_slow = input.int(26, title="MACD Slow", minval=1, group=input_group_3)
macd_signal = input.int(9, title="MACD Signal", minval=1, group=input_group_3)

input_group_4 = "Volume Settings"
volume_mult = input.float(1.2, title="Volume Multiplier", minval=1.0, group=input_group_4)

input_group_5 = "Risk Management"
atr_len = input.int(14, title="ATR Period", minval=1, group=input_group_5)
sl_pct = input.float(0.8, title="SL Percent", minval=0.1, group=input_group_5)
tp_pct = input.float(1.5, title="TP Percent", minval=0.1, group=input_group_5)
max_bars = input.int(50, title="Max Hold Bars", minval=10, group=input_group_5)

ema_fast = ta.ema(close, ema_fast_len)
ema_slow = ta.ema(close, ema_slow_len)

rsi = ta.rsi(close, rsi_len)

macd_line = ta.ema(close, macd_fast) - ta.ema(close, macd_slow)
macd_sig = ta.ema(macd_line, macd_signal)
macd_hist = macd_line - macd_sig

atr = ta.atr(atr_len)
avg_vol = ta.sma(volume, 20)

trend_up = ema_fast > ema_slow
trend_down = ema_fast < ema_slow

volume_confirmed = volume > (avg_vol * volume_mult)

rsi_oversold_area = rsi < rsi_oversold
rsi_overbought_area = rsi > rsi_overbought

macd_bullish = macd_hist > 0
macd_bearish = macd_hist < 0

macd_cross_up = ta.crossover(macd_line, macd_sig)
macd_cross_down = ta.crossunder(macd_line, macd_sig)

rsi_cross_up = ta.crossover(rsi, rsi_oversold)
rsi_cross_down = ta.crossunder(rsi, rsi_overbought)

rsi_div_buy = rsi[1] < rsi[2] and rsi < rsi[1] and low < low[1] and close > close[1]
rsi_div_sell = rsi[1] > rsi[2] and rsi > rsi[1] and high > high[1] and close < close[1]

ema_cross_up = ta.crossover(ema_fast, ema_slow)
ema_cross_down = ta.crossunder(ema_fast, ema_slow)

buy_signal1 = trend_up and rsi_cross_up and volume_confirmed
buy_signal2 = trend_up and rsi_div_buy and volume_confirmed
buy_signal3 = ema_cross_up and macd_cross_up and volume_confirmed

buy_signal = buy_signal1 or buy_signal2 or buy_signal3

sell_signal1 = trend_down and rsi_cross_down and volume_confirmed
sell_signal2 = trend_down and rsi_div_sell and volume_confirmed
sell_signal3 = ema_cross_down and macd_cross_down and volume_confirmed

sell_signal = sell_signal1 or sell_signal2 or sell_signal3

var float entry_price = na
var int bars_in_position = 0
var float sl_price = na
var float tp_price = na

if buy_signal and strategy.position_size == 0
    entry_price := close
    bars_in_position := 0
    sl_price := entry_price * (1 - sl_pct / 100)
    tp_price := entry_price * (1 + tp_pct / 100)
    strategy.entry("LONG", strategy.long)

if sell_signal and strategy.position_size == 0
    entry_price := close
    bars_in_position := 0
    sl_price := entry_price * (1 + sl_pct / 100)
    tp_price := entry_price * (1 - tp_pct / 100)
    strategy.entry("SHORT", strategy.short)

if strategy.position_size > 0
    bars_in_position += 1
    strategy.exit("LONG_EXIT", "LONG", stop=sl_price, limit=tp_price)
    if bars_in_position > max_bars
        strategy.close("LONG")

if strategy.position_size < 0
    bars_in_position += 1
    strategy.exit("SHORT_EXIT", "SHORT", stop=sl_price, limit=tp_price)
    if bars_in_position > max_bars
        strategy.close("SHORT")

plotshape(buy_signal, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.small)
plotshape(sell_signal, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.small)

plot(ema_fast, color=color.new(color.blue, 0), linewidth=2, title="EMA5")
plot(ema_slow, color=color.new(color.orange, 0), linewidth=2, title="EMA20")
