//@version=6
strategy("CDTS 15M Scalping", overlay=true, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=5)

input_group_1 = "Moving Averages"
fast_ma = input.int(9, title="Fast MA (EMA)", minval=1, group=input_group_1)
slow_ma = input.int(21, title="Slow MA (EMA)", minval=1, group=input_group_1)

input_group_2 = "RSI Settings"
rsi_len = input.int(14, title="RSI Length", minval=1, group=input_group_2)
rsi_ob = input.int(70, title="RSI Overbought", minval=50, maxval=100, group=input_group_2)
rsi_os = input.int(30, title="RSI Oversold", minval=0, maxval=50, group=input_group_2)

input_group_3 = "Stochastic Settings"
k_len = input.int(14, title="Stochastic K Period", minval=1, group=input_group_3)
d_len = input.int(3, title="Stochastic D Period", minval=1, group=input_group_3)
k_smooth = input.int(3, title="Stochastic K Smoothing", minval=1, group=input_group_3)
stoch_ob = input.int(80, title="Stoch Overbought", minval=50, maxval=100, group=input_group_3)
stoch_os = input.int(20, title="Stoch Oversold", minval=0, maxval=50, group=input_group_3)

input_group_4 = "MACD Settings"
macd_fast = input.int(12, title="MACD Fast", minval=1, group=input_group_4)
macd_slow = input.int(26, title="MACD Slow", minval=1, group=input_group_4)
macd_signal = input.int(9, title="MACD Signal", minval=1, group=input_group_4)

input_group_5 = "Volume Settings"
volume_mult = input.float(1.3, title="Volume Spike Multiplier", minval=1.0, group=input_group_5)

input_group_6 = "Risk Management"
use_atr = input.bool(true, title="Use ATR for SL/TP", group=input_group_6)
atr_len = input.int(14, title="ATR Length", minval=1, group=input_group_6)
sl_mult = input.float(1.0, title="SL Multiplier", minval=0.5, group=input_group_6)
tp_mult = input.float(2.0, title="TP Multiplier", minval=1.0, group=input_group_6)
fixed_sl = input.float(0.5, title="Fixed SL % (if ATR off)", minval=0.1, group=input_group_6)
fixed_tp = input.float(1.2, title="Fixed TP % (if ATR off)", group=input_group_6)
max_bars = input.int(60, title="Max Bars Hold", minval=10, group=input_group_6)

ema_fast = ta.ema(close, fast_ma)
ema_slow = ta.ema(close, slow_ma)

rsi_val = ta.rsi(close, rsi_len)
avg_vol = ta.sma(volume, 20)

macd_line = ta.ema(close, macd_fast) - ta.ema(close, macd_slow)
macd_sig = ta.ema(macd_line, macd_signal)
macd_hist = macd_line - macd_sig

lowest_low = ta.lowest(low, k_len)
highest_high = ta.highest(high, k_len)
k_raw = 100 * (close - lowest_low) / (highest_high - lowest_low)
k_val = ta.sma(k_raw, k_smooth)
d_val = ta.sma(k_val, d_len)

atr_val = ta.atr(atr_len)

trend_up = ema_fast > ema_slow
trend_down = ema_fast < ema_slow

ma_cross_up = ta.crossover(ema_fast, ema_slow)
ma_cross_down = ta.crossunder(ema_fast, ema_slow)

rsi_cross_up = ta.crossover(rsi_val, rsi_os)
rsi_cross_down = ta.crossunder(rsi_val, rsi_ob)

stoch_cross_up = ta.crossover(k_val, d_val) and k_val < stoch_os
stoch_cross_down = ta.crossunder(k_val, d_val) and k_val > stoch_ob

macd_cross_up = ta.crossover(macd_line, macd_sig)
macd_cross_down = ta.crossunder(macd_line, macd_sig)

volume_surge = volume > (avg_vol * volume_mult)

rsi_div_up = false
rsi_div_down = false
if rsi_val[1] < rsi_val[2] and rsi_val < rsi_val[1] and low[1] > low and close > close[1]
    rsi_div_up := true
if rsi_val[1] > rsi_val[2] and rsi_val > rsi_val[1] and high[1] < high and close < close[1]
    rsi_div_down := true

buy_signal = trend_up and rsi_cross_up and macd_cross_up and volume_surge
buy_signal := buy_signal or (trend_up and rsi_div_up and volume_surge and stoch_cross_up)
buy_signal := buy_signal or (ma_cross_up and rsi_val < rsi_ob and volume_surge)

sell_signal = trend_down and rsi_cross_down and macd_cross_down and volume_surge
sell_signal := sell_signal or (trend_down and rsi_div_down and volume_surge and stoch_cross_down)
sell_signal := sell_signal or (ma_cross_down and rsi_val > rsi_os and volume_surge)

var float entry_price = na
var int bars_held = 0

if buy_signal and strategy.position_size == 0
    entry_price := close
    bars_held := 0
    if use_atr
        sl_price = entry_price - (atr_val * sl_mult)
        tp_price = entry_price + (atr_val * tp_mult)
    else
        sl_price = entry_price * (1 - fixed_sl / 100)
        tp_price = entry_price * (1 + fixed_tp / 100)
    strategy.entry("BUY", strategy.long)
    strategy.exit("BUY_EXIT", "BUY", stop=sl_price, limit=tp_price)

if sell_signal and strategy.position_size == 0
    entry_price := close
    bars_held := 0
    if use_atr
        sl_price = entry_price + (atr_val * sl_mult)
        tp_price = entry_price - (atr_val * tp_mult)
    else
        sl_price = entry_price * (1 + fixed_sl / 100)
        tp_price = entry_price * (1 - fixed_tp / 100)
    strategy.entry("SELL", strategy.short)
    strategy.exit("SELL_EXIT", "SELL", stop=sl_price, limit=tp_price)

if strategy.position_size != 0
    bars_held += 1
    if bars_held > max_bars
        strategy.close_all()

plotshape(buy_signal, style=shape.labelup, location=location.belowbar, color=color.new(color.green, 0), text="BUY", textcolor=color.white, size=size.small)
plotshape(sell_signal, style=shape.labeldown, location=location.abovebar, color=color.new(color.red, 0), text="SELL", textcolor=color.white, size=size.small)

plot(ema_fast, color=color.new(color.blue, 0), linewidth=1, title="EMA9")
plot(ema_slow, color=color.new(color.orange, 0), linewidth=1, title="EMA21")

hline(rsi_ob, color=color.new(color.red, 60), linestyle=hline.style_dashed, title="RSI OB")
hline(rsi_os, color=color.new(color.green, 60), linestyle=hline.style_dashed, title="RSI OS")
